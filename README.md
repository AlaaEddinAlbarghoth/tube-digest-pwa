# TubeDigest PWA

> **Your daily YouTube video summaries powered by AI** - A Progressive Web App that delivers AI-generated summaries of your YouTube subscriptions, helping you stay informed without watching every video.

## ðŸŽ¯ What is TubeDigest?

TubeDigest is a mobile-first PWA that connects to your YouTube Summarizer backend (Google Apps Script) to fetch and display AI-generated summaries of videos from your subscribed channels. Key features include:

- **Daily Digest** - See today's videos at a glance with priority indicators
- **AI Summaries** - Short, medium, and full summaries generated by LLMs
- **Key Ideas & Action Items** - Extracted insights in bullet-point format
- **Smart Filtering** - Filter by date, priority, category, and channel
- **Read Tracking** - Mark videos as read to track your progress
- **Activity Logs** - Monitor backend run history and video processing stats
- **Offline Support** - PWA with service worker for offline access

---

## ðŸš€ Tech Stack

| Layer | Technology |
|-------|------------|
| **UI Framework** | React 18 |
| **Language** | TypeScript (strict mode) |
| **Build Tool** | Vite |
| **Styling** | TailwindCSS 4 |
| **Routing** | React Router 6 |
| **State Management** | Zustand |
| **PWA** | vite-plugin-pwa + Workbox |

---

## ðŸ—ºï¸ Application Routes

| Route | Page | Description |
|-------|------|-------------|
| `/` | TodayDigestPage | Main dashboard with tabs (7d/3d/Today) and filters |
| `/videos` | VideosListPage | Full video archive with advanced filters and search |
| `/videos/:id` | VideoDetailsPage | Video details with summaries, key ideas, and actions |
| `/channels` | ChannelsListPage | Subscribed channels with stats and filters |
| `/activity` | ActivityLogsPage | Backend run history and processing stats |
| `/settings` | SettingsPage | User preferences, theme, and backend info |

---

## ðŸ“ Project Structure

```
tube-digest-pwa/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                    # Core application setup
â”‚   â”‚   â”œâ”€â”€ App.tsx            # Root component with theme management
â”‚   â”‚   â””â”€â”€ routes.tsx         # React Router configuration
â”‚   â”œâ”€â”€ pages/                  # Page components
â”‚   â”‚   â”œâ”€â”€ TodayDigestPage/   # Main digest view
â”‚   â”‚   â”œâ”€â”€ VideosListPage/    # Full video list
â”‚   â”‚   â”œâ”€â”€ VideoDetailsPage/  # Single video details
â”‚   â”‚   â”œâ”€â”€ ChannelsListPage/  # Channel list
â”‚   â”‚   â”œâ”€â”€ ActivityLogsPage/  # Run history
â”‚   â”‚   â””â”€â”€ SettingsPage/      # User settings
â”‚   â”œâ”€â”€ components/             # Reusable components
â”‚   â”‚   â”œâ”€â”€ layout/            # AppLayout, TopBar, BottomNav
â”‚   â”‚   â”œâ”€â”€ features/          # VideoCard, RunLogItem
â”‚   â”‚   â”œâ”€â”€ digest/            # FilterBar
â”‚   â”‚   â””â”€â”€ shared/            # Button, Badge, Card, Toggle, etc.
â”‚   â”œâ”€â”€ state/                 # Zustand stores
â”‚   â”‚   â”œâ”€â”€ videosStore.ts     # Video data and filters
â”‚   â”‚   â”œâ”€â”€ channelsStore.ts   # Channel data
â”‚   â”‚   â”œâ”€â”€ logsStore.ts       # Activity logs
â”‚   â”‚   â””â”€â”€ settingsStore.ts   # User preferences (persisted)
â”‚   â”œâ”€â”€ api/                   # API layer
â”‚   â”‚   â”œâ”€â”€ client.ts          # HTTP client with error handling
â”‚   â”‚   â”œâ”€â”€ videosApi.ts       # Video endpoints
â”‚   â”‚   â”œâ”€â”€ channelsApi.ts     # Channel endpoints
â”‚   â”‚   â”œâ”€â”€ logsApi.ts         # Logs endpoints
â”‚   â”‚   â””â”€â”€ settingsApi.ts     # Settings/meta endpoints
â”‚   â”œâ”€â”€ types/                 # TypeScript interfaces
â”‚   â”œâ”€â”€ config/                # App constants
â”‚   â”œâ”€â”€ styles/                # Global CSS
â”‚   â””â”€â”€ pwa/                   # PWA registration
â”œâ”€â”€ docs/                      # Documentation
â”‚   â”œâ”€â”€ ARCHITECTURE.md        # System architecture
â”‚   â”œâ”€â”€ CODING_GUIDELINES.md   # Code standards
â”‚   â””â”€â”€ FEATURES.md            # Feature documentation
â””â”€â”€ public/                    # Static assets
```

---

## ðŸŽ›ï¸ Filter Model

The PWA uses a unified filter state model with consistent "All" semantics across all filter types.

### Filter State Structure

All filters use **null** to represent "All" (show everything), not a literal string:

```typescript
interface VideoFilters {
    dateRange: DateRangeKey;      // Always required, never null
    status: VideoStatus | null;    // null = All
    priority: Priority | null;     // null = All
    category: string | null;       // null = All
    channelId: string | null;      // null = All
    search: string;                // Empty string = no search
}
```

### "All" Semantics

- **null** means "don't filter by this field" - the filter is not sent to the API
- Only non-null filter values are included in API queries
- This ensures consistent behavior across all filter types (status, priority, category, channelId)

### Default Derivation

- **dateRange**: Defaults to `backendInfo.defaultRange` (e.g., "3d") when backend info loads, or falls back to "3d"
- **status, priority, category, channelId**: Default to `null` (All)
- **search**: Defaults to empty string

### Filter Lifecycle

1. **On Filter Change**:
   - Current video list is cleared immediately
   - Pagination is reset (currentPage = 0, hasMore = false)
   - New fetch is triggered with updated filters
   - This prevents stale data from previous filter states

2. **Query Building**:
   - Only non-null filters are included in API query
   - `dateRange` is always included (required)
   - Example: `{ range: "3d", priority: "high" }` (status, category, channelId are null, so not sent)

3. **BackendInfo Dependency**:
   - Filter options (category, priority) are rendered dynamically from `backendInfo.allowedCategories` and `backendInfo.allowedPriorities`
   - If backendInfo is not loaded, filter sections show loading skeleton
   - After load, filter options are populated from backend taxonomy

### Store Actions

The `videosStore` exposes these filter actions:

- `setFilters(partial)` - Update multiple filters at once
- `setDateRange(range)` - Set date range filter
- `setStatus(status | null)` - Set status filter (null for All)
- `setCategory(category | null)` - Set category filter (null for All)
- `setPriority(priority | null)` - Set priority filter (null for All)
- `resetFilters()` - Reset all filters to defaults

All filter changes automatically trigger a refetch with cleared state to prevent stale data.

## ðŸ› ï¸ Local Development

### Prerequisites

- **Node.js 18+** and **pnpm** installed
- A Google Apps Script backend URL (see Backend Integration)

### Setup

```bash
# 1. Install dependencies
pnpm install

# 2. Configure backend URL
cp .env.example .env
# Edit .env and set VITE_BACKEND_URL

# 3. Start development server
pnpm dev

# 4. Open http://localhost:5173
```

### ðŸ³ Run with Docker

Run the application locally using Docker (no Node.js required on host):

```bash
# 1. Configure environment
cp .env.example .env
# Edit .env and set BACKEND_BASE_URL

# 2. Run with Docker Compose
cd docker
docker compose up --build

# 3. Open http://localhost:5173
```

## Deployment

### Vercel (Recommended for Frontend)

1.  Push your code to a GitHub repository.
2.  Import the project into Vercel.
3.  **Crucial Step:** In the Vercel Project Settings > **Environment Variables**, add:
    *   **Key:** `VITE_BACKEND_URL`
    *   **Value:** `https://script.google.com/macros/s/AKfycbxIcyOCoF1ELz2yRKFFpSH8Y_Uu38KaJoDXpjeYXkM7_ue-0mhL9UqQ5-ZdXz3ldPyk/exec` (Your Apps Script Web App URL)
4.  Deploy.

### Docker

1.  Build and run the container:
    ```bash
    cd docker
    docker compose up -d --build
    ```
2.  Access at `http://localhost:5173`.

### Build for Production

```bash
pnpm build      # Build for production
pnpm preview    # Preview production build locally
```

---

## ðŸ”Œ Backend Integration

TubeDigest connects to a **Google Apps Script** web app that:
1. Fetches videos from your YouTube subscriptions
2. Generates AI summaries using an LLM (Gemini/OpenAI)
3. Stores data in Google Sheets
4. Exposes a REST API for this PWA

### Required Backend Endpoints

The Apps Script backend must implement these endpoints:

| Endpoint | Method | Description |
|----------|--------|-------------|
| `?action=listVideos` | GET | Fetch videos with optional filters (dateRange, status, priority, channelId) |
| `?action=getVideo&id={id}` | GET | Get single video details with full summaries |
| `?action=markVideoRead` | POST | Mark a video as read |
| `?action=listChannels` | GET | Get all subscribed channels |
| `?action=listRuns` | GET | Get processing run history |
| `?action=getBackendInfo` | GET | Get backend metadata (schedule, version) |

### API Response Format

All endpoints return JSON with this structure:

```json
{
  "success": true,
  "data": { ... },
  "error": null
}
```

### Environment Configuration

Create a `.env` file with:

```env
VITE_BACKEND_URL=https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec
```

---

## ðŸ“± PWA Features

- **Installable** - Add to home screen on Android, iOS, and desktop
- **Offline-ready** - Service worker caches app shell
- **Auto-updates** - Prompts user when new version is available
- **Responsive** - Mobile-first design with bottom navigation

---

## ðŸŽ¨ Design System

| Token | Value |
|-------|-------|
| **Primary** | `#135bec` (Blue) |
| **Background (Dark)** | `#0a0a0a` / `#101622` |
| **Background (Light)** | `#ffffff` / `#f9fafb` |
| **Font** | System UI / Inter / Manrope |
| **Border Radius** | `0.75rem` (cards), `9999px` (pills) |

---

## ðŸ”§ Engineering Workflow and Verification

### Change-Set Definition

A **change-set** is a logical unit of work that:
- Solves one specific problem or adds one feature
- Is self-contained and testable
- Can be verified independently
- Has clear success criteria

Examples:
- Adding a new filter option
- Fixing filter state inconsistency
- Updating UI components
- Refactoring store logic

### Mandatory Workflow Per Change-Set

**Every change-set MUST end with these steps in order:**

1. **Local Verification**
   ```bash
   pnpm install          # Ensure dependencies are up to date
   pnpm typecheck        # Verify TypeScript types are correct
   pnpm build            # Ensure build completes successfully
   ```
   - Type check must pass with no errors
   - Build must complete successfully
   - Check for build warnings

2. **Local Dev Verification**
   ```bash
   pnpm dev
   ```
   - Test changed functionality in browser
   - Verify no console errors
   - Check responsive behavior

3. **Commit**
   - Use clear, descriptive commit messages (see Commit Message Conventions below)
   - Commit only related changes together
   - Example: `git commit -m "refactor: unify PWA filter state and query building"`

4. **Push to GitHub**
   - Always push immediately after committing
   - Example: `git push origin main`
   - **Deployment is handled by Vercel automatic builds on push to main.**

5. **Deployed Verification (Vercel)**
   - Wait for Vercel auto-deploy to complete
   - Test on production URL
   - Verify PWA cache updates correctly

### Local Dev Verification Steps

**Before committing, verify:**

1. **Build and Type Check:**
   ```bash
   pnpm typecheck && pnpm build
   ```

2. **Dev Server:**
   ```bash
   pnpm dev
   ```
   - Open browser to `http://localhost:5173`
   - Test all affected pages
   - Check browser console for errors

3. **Filter Functionality:**
   - Test date range chips (Today, 3d, 7d)
   - Test status filter (All, New, Read)
   - Test category filter (All + dynamic categories)
   - Test priority filter (All + dynamic priorities)
   - Verify filters work together correctly

4. **Theme Switching:**
   - Toggle between light/dark/system themes
   - Verify theme persists across page navigation

5. **PWA Cache:**
   - Open DevTools â†’ Application â†’ Service Workers
   - Test "Reset App Cache" in Settings
   - Verify service worker updates correctly

### Deployed Verification Steps (Vercel)

**After push and Vercel deploy:**

1. **Production URL:**
   - Open deployed PWA URL
   - Verify no console errors
   - Check network tab for API calls

2. **PWA Cache Hard Refresh:**
   - Open DevTools â†’ Application â†’ Clear storage
   - Click "Clear site data"
   - Reload page
   - Verify app loads correctly

3. **Service Worker Reset:**
   - DevTools â†’ Application â†’ Service Workers
   - Click "Unregister" if needed
   - Reload page to re-register
   - Verify new version is active

4. **Filter UI Verification:**
   - Test all filter chips render correctly
   - Verify "All" chips work (null semantics)
   - Check dynamic categories/priorities load from backend
   - Test filter combinations

### Recheck After Time (6-24 Hours)

After deploying changes, recheck within 6-24 hours:

1. **Production Stability:**
   - Verify no error reports in Vercel logs
   - Check browser console for runtime errors
   - Confirm API calls are successful

2. **PWA Updates:**
   - Test on mobile device if possible
   - Verify service worker updates automatically
   - Check offline functionality still works

3. **Backend Integration:**
   - Verify `getBackendInfo` returns expected data
   - Confirm `allowedCategories` and `allowedPriorities` are consumed correctly
   - Test filter queries match backend expectations

### Operator Checklist (Before Declaring Fix Done)

Use this checklist before marking any change-set as complete:

**Build and Type Check:**
- âœ… `pnpm typecheck` passes
- âœ… `pnpm build` completes without errors

**Local UI Sanity:**
- âœ… Date range chips work (Today, 3d, 7d)
- âœ… Status filter works (All, New, Read)
- âœ… Category filter works (All + dynamic categories from backend)
- âœ… Priority filter works (All + dynamic priorities from backend)
- âœ… Theme switching works (light/dark/system)
- âœ… Filters work together (no conflicts)

**Backend API Sanity:**
```bash
# Test getBackendInfo
curl "YOUR_BACKEND_URL?action=getBackendInfo&token=YOUR_TOKEN"

# Test listVideos
curl "YOUR_BACKEND_URL?action=listVideos&range=3d&token=YOUR_TOKEN"
```

**Expected Results:**
- âœ… `getBackendInfo` returns valid JSON with `allowedCategories` and `allowedPriorities`
- âœ… `listVideos` returns array of videos with correct structure
- âœ… No CORS errors or 500 responses

**PWA Cache and Service Worker:**
- âœ… Service worker registers correctly
- âœ… "Reset App Cache" button works
- âœ… Hard refresh clears stale data
- âœ… New deployments update service worker

**Production Verification:**
- âœ… Vercel deploy succeeds
- âœ… Production URL loads without errors
- âœ… All filter chips render correctly
- âœ… API calls succeed in production

### Commit Message Conventions

Use these prefixes for commit messages:

- **`feat:`** - New feature or capability
  - Example: `feat: render category filters from backend allowedCategories`

- **`fix:`** - Bug fix
  - Example: `fix: handle null keys in filter chip components`

- **`refactor:`** - Code restructuring without changing behavior
  - Example: `refactor: unify PWA filter state and query building`

- **`docs:`** - Documentation changes only
  - Example: `docs: add filter and release verification policy`

- **`chore:`** - Maintenance tasks, dependencies, config
  - Example: `chore: update dependencies`

- **`style:`** - Code style changes (formatting, whitespace)
  - Example: `style: format code with prettier`

**Format:** `<type>: <brief description>`

Keep descriptions concise but descriptive. If needed, add a body paragraph explaining the "why" for complex changes.

## ðŸ“– Documentation

- **[ARCHITECTURE.md](docs/ARCHITECTURE.md)** - System architecture and data flow
- **[CODING_GUIDELINES.md](docs/CODING_GUIDELINES.md)** - Code standards and patterns
- **[FEATURES.md](docs/FEATURES.md)** - Feature documentation per page
- **[Quickstart](docs/QUICKSTART.md)** - Quick setup guide
- **[Reference](docs/reference/CODE_REFERENCE.md)** - Codebase reference
- **[Reports](docs/reports/)** - Project status and progress reports

---

## ðŸ”§ Troubleshooting

### Build Errors
- Ensure `tsconfig.json` has proper path aliases
- Restart IDE after configuration changes

### PWA Not Installing
- PWA requires HTTPS in production
- Check manifest.json in DevTools â†’ Application

### API Connection Issues
- **Verify Backend URL:** Check `VITE_BACKEND_URL` in your Vercel/environment settings.
- **Anonymous Access:** The Apps Script Web App **MUST** be set to execute as "Me" and access "Anyone" (Anonymous). If set to "Anyone with Google Account", the PWA will fail with CORS/Network errors because it cannot handle the login redirect flow.
- **Test with Curl:** `curl -L "YOUR_BACKEND_URL?action=getBackendInfo"`. It should return JSON, not HTML.

### Data Not Updating
- **App Updates:** The PWA caches heavily. If meaningful changes (like backend URL) are made, you may need to:
    1.  Open DevTools -> Application -> Service Workers -> **Unregister**.
    2.  Reload the page (Cmd+Shift+R).
- **Default Filters:** The app defaults to recent data (3d). Check if your backend has processed new videos recently using the Activity Log.

### Styling / Dark Mode
- **Tailwind v4 Note:** We use a custom variant `@custom-variant dark (&:where(.dark, .dark *));` in `src/styles/globals.css` because standard Tailwind v4 dark mode relies purely on system reference. This custom rule allows our specific `.dark` class toggle to work correctly to support manual theme switching.

---

## ðŸ“„ License

MIT

---

**Version:** 1.0.0  
**Last Updated:** 2025-12-04

---

## References

### Project Reference
- [Project Idea & Discussion](https://chatgpt.com/c/692fe539-bba8-832f-9a51-2405f17885cc)

### Design Reference
- [Stitch Project](https://stitch.withgoogle.com/projects/7484079189251965390)

### YouTube Digest Backend (Apps Script)
- [Google Apps Script Project](https://script.google.com/u/0/home/projects/1YoPbY_AK0pFIJ6eFv8FxtRyyA3p1hlBHW19n19VT-eKFLpBnZgllB_T_)

### YouTube Summarizer Backend (GitHub Repo)
- [yt-subscriptions-summarizer](https://github.com/AlaaEddinAlbarghoth/yt-subscriptions-summarizer)
