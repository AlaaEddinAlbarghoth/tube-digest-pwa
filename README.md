# TubeDigest PWA

> **Your daily YouTube video summaries powered by AI** - A Progressive Web App that delivers AI-generated summaries of your YouTube subscriptions, helping you stay informed without watching every video.

<!-- Test deployment trigger -->

## ðŸŽ¯ What is TubeDigest?

TubeDigest is a mobile-first PWA that connects to your YouTube Summarizer backend (Google Apps Script) to fetch and display AI-generated summaries of videos from your subscribed channels. Key features include:

- **Daily Digest** - See today's videos at a glance with priority indicators
- **AI Summaries** - Short, medium, and full summaries generated by LLMs
- **Key Ideas & Action Items** - Extracted insights in bullet-point format
- **Smart Filtering** - Filter by date, priority, category, and channel
- **Read Tracking** - Mark videos as read to track your progress
- **Activity Logs** - Monitor backend run history and video processing stats
- **Offline Support** - PWA with service worker for offline access

---

## ðŸš€ Tech Stack

| Layer | Technology |
|-------|------------|
| **UI Framework** | React 18 |
| **Language** | TypeScript (strict mode) |
| **Build Tool** | Vite |
| **Styling** | TailwindCSS 4 |
| **Routing** | React Router 6 |
| **State Management** | Zustand |
| **PWA** | vite-plugin-pwa + Workbox |

---

## ðŸ—ºï¸ Application Routes

| Route | Page | Description |
|-------|------|-------------|
| `/` | TodayDigestPage | Main dashboard with tabs (7d/3d/Today) and filters |
| `/videos` | VideosListPage | Full video archive with advanced filters and search |
| `/videos/:id` | VideoDetailsPage | Video details with summaries, key ideas, and actions |
| `/channels` | ChannelsListPage | Subscribed channels with stats and filters |
| `/activity` | ActivityLogsPage | Backend run history and processing stats |
| `/settings` | SettingsPage | User preferences, theme, and backend info |

---

## ðŸ“ Project Structure

```
tube-digest-pwa/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                    # Core application setup
â”‚   â”‚   â”œâ”€â”€ App.tsx            # Root component with theme management
â”‚   â”‚   â””â”€â”€ routes.tsx         # React Router configuration
â”‚   â”œâ”€â”€ pages/                  # Page components
â”‚   â”‚   â”œâ”€â”€ TodayDigestPage/   # Main digest view
â”‚   â”‚   â”œâ”€â”€ VideosListPage/    # Full video list
â”‚   â”‚   â”œâ”€â”€ VideoDetailsPage/  # Single video details
â”‚   â”‚   â”œâ”€â”€ ChannelsListPage/  # Channel list
â”‚   â”‚   â”œâ”€â”€ ActivityLogsPage/  # Run history
â”‚   â”‚   â””â”€â”€ SettingsPage/      # User settings
â”‚   â”œâ”€â”€ components/             # Reusable components
â”‚   â”‚   â”œâ”€â”€ layout/            # AppLayout, TopBar, BottomNav
â”‚   â”‚   â”œâ”€â”€ features/          # VideoCard, RunLogItem
â”‚   â”‚   â”œâ”€â”€ digest/            # FilterBar
â”‚   â”‚   â””â”€â”€ shared/            # Button, Badge, Card, Toggle, etc.
â”‚   â”œâ”€â”€ state/                 # Zustand stores
â”‚   â”‚   â”œâ”€â”€ videosStore.ts     # Video data and filters
â”‚   â”‚   â”œâ”€â”€ channelsStore.ts   # Channel data
â”‚   â”‚   â”œâ”€â”€ logsStore.ts       # Activity logs
â”‚   â”‚   â””â”€â”€ settingsStore.ts   # User preferences (persisted)
â”‚   â”œâ”€â”€ api/                   # API layer
â”‚   â”‚   â”œâ”€â”€ client.ts          # HTTP client with error handling
â”‚   â”‚   â”œâ”€â”€ videosApi.ts       # Video endpoints
â”‚   â”‚   â”œâ”€â”€ channelsApi.ts     # Channel endpoints
â”‚   â”‚   â”œâ”€â”€ logsApi.ts         # Logs endpoints
â”‚   â”‚   â””â”€â”€ settingsApi.ts     # Settings/meta endpoints
â”‚   â”œâ”€â”€ types/                 # TypeScript interfaces
â”‚   â”œâ”€â”€ config/                # App constants
â”‚   â”œâ”€â”€ styles/                # Global CSS
â”‚   â””â”€â”€ pwa/                   # PWA registration
â”œâ”€â”€ docs/                      # Documentation
â”‚   â”œâ”€â”€ ARCHITECTURE.md        # System architecture
â”‚   â”œâ”€â”€ CODING_GUIDELINES.md   # Code standards
â”‚   â””â”€â”€ FEATURES.md            # Feature documentation
â””â”€â”€ public/                    # Static assets
```

---

## ðŸŒ RTL and BiDi Support

The PWA uses **text-level RTL** for Arabic content while keeping the overall application layout **LTR** (Left-to-Right). This ensures proper rendering of Arabic text without flipping the entire UI.

### Layout Direction

**App-Level Direction:**
- The app layout is **LTR by default** (`document.documentElement.dir = "ltr"`)
- RTL is applied **only at the text element level** when Arabic characters are detected
- This keeps navigation, filters, settings, and other UI components in their natural LTR layout

### BiDi Utility Classes

The following utility classes are available in `src/styles/globals.css`:

- `.rtl-text` - Sets direction RTL, text-align right, and `unicode-bidi: plaintext` for Arabic content
- `.ltr-text` - Sets direction LTR, text-align left, and `unicode-bidi: plaintext` for English/URLs/code
- `.bidi-plain` - Applies `unicode-bidi: plaintext` for mixed content
- `.bidi-isolate` - Applies `unicode-bidi: isolate` for isolated bidirectional text

### Arabic Detection Helper

A reusable helper is available in `src/utils/bidi.ts`:

```typescript
import { bidiTextClass, bidiPlainClass, hasArabic } from '@/utils/bidi';

// Check if string contains Arabic
hasArabic(text); // returns boolean

// Get appropriate class for text
bidiTextClass(text); // returns "rtl-text" or "ltr-text"

// Get class with plaintext isolation (for mixed content)
bidiPlainClass(text); // returns "rtl-text bidi-plain" or "ltr-text"
```

### Text-Level RTL Application

**Apply RTL only to text elements that contain Arabic:**

- **Video titles** - Use `bidiTextClass(video.title)`
- **Channel names** - Use `bidiTextClass(channel.name)`
- **Summaries** - Use `bidiPlainClass(summary)` for mixed content
- **Category labels** - Use `bidiTextClass(category)`
- **Key ideas and action items** - Use `bidiPlainClass(idea)`
- **Empty state descriptions** - Use `bidiTextClass(description)` if Arabic

**Always use LTR for:**
- Date/time strings (English format: "MMM d, yyyy", "h:mm a", etc.)
- URLs and YouTube video IDs
- Code snippets or technical identifiers (Sheet IDs, build hashes)
- Timestamps and relative time strings ("2 hours ago")
- Numeric metadata values in English format

### Automatic Detection

- The `Chip` component uses `bidiTextClass()` to automatically detect Arabic and apply RTL
- This ensures category and priority filter chips render correctly without manual intervention
- "All" and English labels remain LTR

### Developer Guidelines

1. **Never wrap entire pages or containers with RTL classes**
2. **Apply RTL classes only to the exact text nodes** that may contain Arabic
3. **Use `bidiTextClass()` helper** for simple text elements
4. **Use `bidiPlainClass()` helper** for mixed content (summaries, key ideas)
5. **Always use explicit `.ltr-text`** for technical values, dates, and code

### Known Edge Cases

1. **Mixed Arabic/English in summaries**: The `bidiPlainClass()` helper with `unicode-bidi: plaintext` handles inline English phrases automatically.

2. **Date/time formatting**: All date/time strings use explicit `.ltr-text` to ensure proper formatting.

3. **Filter chips**: The `Chip` component automatically detects Arabic using `bidiTextClass()`, so category and priority filters work correctly.

4. **Technical identifiers**: Sheet IDs, build hashes, and other code-like values always use explicit `.ltr-text` to maintain readability.

5. **Channel names with mixed content**: Channel names use `bidiTextClass()` which detects Arabic and applies RTL, while embedded English renders correctly due to `unicode-bidi: plaintext`.

---

## ðŸŽ›ï¸ Filter Model

The PWA uses a unified filter state model with consistent "All" semantics across all filter types.

### Filter State Structure

All filters use **null** to represent "All" (show everything), not a literal string:

```typescript
interface VideoFilters {
    dateRange: DateRangeKey;      // Always required, never null
    status: VideoStatus | null;    // null = All
    priority: Priority | null;     // null = All
    category: string | null;       // null = All
    channelId: string | null;      // null = All
    search: string;                // Empty string = no search
}
```

### "All" Semantics

- **null** means "don't filter by this field" - the filter is not sent to the API
- Only non-null filter values are included in API queries
- This ensures consistent behavior across all filter types (status, priority, category, channelId)

### Default Derivation

- **dateRange**: Defaults to `backendInfo.defaultRange` (e.g., "3d") when backend info loads, or falls back to "3d"
- **status, priority, category, channelId**: Default to `null` (All)
- **search**: Defaults to empty string

### Filter Lifecycle

1. **On Filter Change**:
   - Current video list is cleared immediately
   - Pagination is reset (currentPage = 0, hasMore = false)
   - New fetch is triggered with updated filters
   - This prevents stale data from previous filter states

2. **Query Building**:
   - Only non-null filters are included in API query
   - `dateRange` is always included (required)
   - Example: `{ range: "3d", priority: "high" }` (status, category, channelId are null, so not sent)

3. **BackendInfo Dependency**:
   - Filter options (category, priority) are rendered dynamically from `backendInfo.allowedCategories` and `backendInfo.allowedPriorities`
   - If backendInfo is not loaded, filter sections show loading skeleton
   - After load, filter options are populated from backend taxonomy

### Store Actions

The `videosStore` exposes these filter actions:

- `setFilters(partial)` - Update multiple filters at once
- `setDateRange(range)` - Set date range filter
- `setStatus(status | null)` - Set status filter (null for All)
- `setCategory(category | null)` - Set category filter (null for All)
- `setPriority(priority | null)` - Set priority filter (null for All)
- `resetFilters()` - Reset all filters to defaults

All filter changes automatically trigger a refetch with cleared state to prevent stale data.

## ðŸ› ï¸ Local Development

### Prerequisites

- **Node.js 18+** and **pnpm** installed
- A Google Apps Script backend URL (see Backend Integration)

### Setup

```bash
# 1. Install dependencies
pnpm install

# 2. Configure backend URL
cp .env.example .env
# Edit .env and set VITE_BACKEND_URL

# 3. Start development server
pnpm dev

# 4. Open http://localhost:5173
```

### ðŸ³ Run with Docker

Run the application locally using Docker (no Node.js required on host):

```bash
# 1. Configure environment
cp .env.example .env
# Edit .env and set BACKEND_BASE_URL

# 2. Run with Docker Compose
cd docker
docker compose up --build

# 3. Open http://localhost:5173
```

## Deployment

### Vercel (Recommended for Frontend)

1.  Push your code to a GitHub repository.
2.  Import the project into Vercel.
3.  **Crucial Step:** In the Vercel Project Settings > **Environment Variables**, add:
    *   **Key:** `VITE_BACKEND_URL`
    *   **Value:** `https://script.google.com/macros/s/AKfycbxIcyOCoF1ELz2yRKFFpSH8Y_Uu38KaJoDXpjeYXkM7_ue-0mhL9UqQ5-ZdXz3ldPyk/exec` (Your Apps Script Web App URL)
4.  **Configure Deployment Settings:**
    *   Go to **Project Settings** > **Git**
    *   Set **Production Branch** to `main`
    *   Enable **Automatic Deployments** for the `main` branch
    *   **Disable Preview Deployments** (uncheck "Create Preview Deployments for Pull Requests")
    *   This ensures only production deploys from `main`, no preview branches
5.  Deploy.

### Docker

1.  Build and run the container:
    ```bash
    cd docker
    docker compose up -d --build
    ```
2.  Access at `http://localhost:5173`.

### Build for Production

```bash
pnpm build      # Build for production
pnpm preview    # Preview production build locally
```

---

## ðŸ”Œ Backend Integration

TubeDigest connects to a **Google Apps Script** web app that:
1. Fetches videos from your YouTube subscriptions
2. Generates AI summaries using an LLM (Gemini/OpenAI)
3. Stores data in Google Sheets
4. Exposes a REST API for this PWA

### Required Backend Endpoints

The Apps Script backend must implement these endpoints:

| Endpoint | Method | Description |
|----------|--------|-------------|
| `?action=listVideos` | GET | Fetch videos with optional filters (dateRange, status, priority, channelId) |
| `?action=getVideo&id={id}` | GET | Get single video details with full summaries |
| `?action=markVideoRead` | POST | Mark a video as read |
| `?action=listChannels` | GET | Get all subscribed channels |
| `?action=listRuns` | GET | Get processing run history |
| `?action=getBackendInfo` | GET | Get backend metadata (schedule, version) |

### API Response Format

All endpoints return JSON with this structure:

```json
{
  "success": true,
  "data": { ... },
  "error": null
}
```

### Environment Configuration

Create a `.env` file with:

```env
VITE_BACKEND_URL=https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec
```

**Note:** The app works without `VITE_BACKEND_URL` - it uses a hardcoded fallback URL. Setting `VITE_BACKEND_URL` is optional and only needed if you want to use a different backend URL.

**Backend Deployment (Optional):**
- The app works with the existing Apps Script Web App deployment
- Creating a new deployment is optional and only affects optional metadata fields in the Settings page
- Core functionality (video listing, summaries) works without redeployment

---

## ðŸ“± PWA Features

- **Installable** - Add to home screen on Android, iOS, and desktop
- **Offline-ready** - Service worker caches app shell
- **Auto-updates** - Prompts user when new version is available
- **Auto-refresh** - Video lists automatically refresh every 90 seconds (with jitter) when page is visible
- **Responsive** - Mobile-first design with bottom navigation

### Auto-Refresh Behavior

The app automatically refreshes video lists on the **Today Digest** and **Videos List** pages to ensure users always see the latest content:

- **Polling Interval:** 90 seconds (with Â±10 seconds jitter to avoid synchronized bursts)
- **Visibility-Aware:** Polling stops when the browser tab is hidden and resumes when visible
- **Non-Intrusive:** Auto-refresh preserves the current list and scroll position, only updating when new videos are available
- **Request Cancellation:** In-flight requests are automatically cancelled if a new refresh cycle starts
- **Last Updated Indicator:** Shows "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: HH:MM" (Last updated: HH:MM) at the top of video lists

This ensures zero manual work is required - new videos appear automatically without user intervention.

---

## ðŸŽ¨ UI Enhancements

The PWA includes several UX improvements for better usability and scalability. These features were delivered in a combined commit (`9de4800`), and future enhancements should follow stepwise commits for better traceability.

### Search

**Behavior:**
- **Local Search**: Search input filters videos locally over the already loaded list (does not trigger API calls)
- **Search Fields**: Searches across `video.title` and `channel.name` (case-insensitive)
- **Debouncing**: Input is debounced by 200ms to reduce unnecessary filtering operations
- **Bilingual Support**: Search placeholder supports both Arabic and English text
- **Persistent State**: Search term is stored in the videos store and persists across page navigation
- **Performance**: Search filtering is memoized to avoid unnecessary re-computation on every render

**Implementation Notes:**
- Search is applied in the UI layer (pages), not in the store, keeping store data complete
- Search works with both Arabic and English text using case-insensitive matching
- Clearing search restores the full list immediately

### Sort Controls

**Sort Options:**
- **Newest first** (default) - Most recently published videos first, sorted by `publishedAt` descending
- **Oldest first** - Oldest videos first, sorted by `publishedAt` ascending
- **Duration (longest)** - Longest videos first, sorted by `durationSeconds` descending
- **Duration (shortest)** - Shortest videos first, sorted by `durationSeconds` ascending
- **Priority (High to Low)** - High priority videos first, then by date (newest first) as secondary sort

**Behavior:**
- **Stable Sorting**: Sorting preserves original order for items with equal values (e.g., same published date)
- **Local Sorting**: Sorting applies to the filtered local list (after search filter is applied)
- **Performance**: Sorting is memoized and only re-computes when `videoIds`, `videos`, `filters.search`, or `filters.sort` change

### Filters Panel

**Layout:**
- **Status Always Visible**: Status filters (All, New, Read) remain visible at all times for quick access
- **Collapsible Section**: Priority and Category filters are moved into a collapsible "More Filters" panel
- **Active Filter Indicator**: Shows a badge count (e.g., "2") when Priority or Category filters are active
- **Reset Filters**: Quick "Reset Filters" button appears when any filters are active, clears all filters to defaults

**Behavior:**
- Clicking "More Filters" toggles the collapsible section
- Active filters are visually indicated with active chip styling
- Reset button only appears when filters are active
- Layout remains clean on small screens with horizontal scrolling for filter chips

### List Header Status

**Counts Chip:**
- **Format**: "X / Y" where X is the number of videos currently displayed (after search/sort filtering) and Y is `totalMatching` from the backend API
- **Meaning**: 
  - X reflects the local filtered/sorted list count
  - Y reflects the total count matching the backend filters (dateRange, status, priority, category, channelId) for the selected range
  - If Y is "--", the backend did not provide `totalMatching` (graceful degradation)
- **Progress Indicator**: Subtle mini spinner (3px border, blue) appears while `loading` is true
- **Last Updated**: Shows "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: HH:MM" (Last updated: HH:MM) as secondary meta, aligned to the right
- **Consistent Alignment**: Status information aligned consistently across Today Digest and Videos List pages

### Loading and Empty States

**Skeleton Cards:**
- Shows 3 animated skeleton cards during initial load (`loading && filteredVideos.length === 0`)
- Also appears during filter changes when the list is cleared
- Skeleton matches the structure of `VideoCard` (avatar, title, badges, buttons)

**Empty State Messages:**
- **No Search Results**: "No results found" with message "No videos match '[search term]'. Try adjusting your search or filters." and "Clear Search" button
- **No Filter Results**: "No videos found" with message "Try adjusting your filters or check back later for new summaries." and "Refresh" button
- **Error State**: "Error loading videos" with error message and "Retry" button

### Desktop Master-Detail Layout

**Two-Column Layout:**
- **Breakpoint**: Activates on screens â‰¥1024px (Tailwind `lg:` breakpoint)
- **Left Column**: Video list (flexible width, scrollable)
- **Right Column**: Video preview panel (fixed 384px width, `lg:w-96`)
- **Border**: Vertical border between columns in light/dark mode

**Preview Panel Behavior:**
- **Selection**: Clicking a video card updates the preview panel without navigation
- **Visual Feedback**: Selected video card shows a blue ring indicator (`ring-2 ring-blue-500`)
- **Preview Content**: Shows video title, channel name, published time, duration, badges (priority, status, category), short summary, description (truncated to 6 lines), and action buttons
- **Empty State**: When no video is selected, shows "ðŸ‘ˆ Select a video to preview" message

**Mobile Behavior:**
- On screens <1024px, maintains single-column layout
- Clicking a video card navigates to the full details page (standard behavior)
- Preview panel is hidden on mobile (`hidden lg:block`)

**Auto-Refresh Compatibility:**
- Auto-refresh uses `preserveList=true` to avoid clearing the list during background updates
- Scroll position is preserved because the DOM elements remain (only data updates)
- Selected video state persists across auto-refresh cycles

### Additional UX Enhancements

**Manual Refresh Button:**
- Small refresh icon button appears next to the "Last updated" indicator on both Today Digest and Videos List pages
- On click, triggers an immediate fetch using `preserveList=true` behavior (consistent with auto-refresh)
- Shows a subtle loading spinner on the button while the request is in flight
- Does not reset scroll position, maintaining user's place in the list

**Sticky List Header:**
- The filters area (status chips, counts line, search, sort controls) is sticky while scrolling
- Uses `shadow-sm` for visual separation and proper z-index to avoid content overlap
- Works correctly with RTL alignment and maintains consistent dark theme styling
- No layout jump - background and borders ensure smooth scrolling experience

**No Summary Badge:**
- Videos without summaries (missing `shortSummary`, `mediumSummary`, and `fullSummary`) display a neutral badge: "Ø¨Ø¯ÙˆÙ† Ù…Ù„Ø®Øµ Ø¨Ø¹Ø¯"
- Badge appears in the badges row alongside priority, status, and category badges
- Automatically disappears when a summary becomes available
- Uses neutral gray styling to indicate pending state without alarming the user

---

## ðŸŽ¨ Design System

| Token | Value |
|-------|-------|
| **Primary** | `#135bec` (Blue) |
| **Background (Dark)** | `#0a0a0a` / `#101622` |
| **Background (Light)** | `#ffffff` / `#f9fafb` |
| **Font** | System UI / Inter / Manrope |
| **Border Radius** | `0.75rem` (cards), `9999px` (pills) |

---

## ðŸŒ RTL and BiDi Support

The PWA is designed as an Arabic-first application with full RTL (Right-to-Left) support for proper rendering of Arabic content mixed with English text, URLs, and code.

### RTL Configuration

**App-Level Direction:**
- The app sets `document.documentElement.dir = "rtl"` and `document.documentElement.lang = "ar"` on mount
- This ensures the entire application renders in RTL mode by default

**BiDi Utility Classes:**
The following utility classes are available in `src/styles/globals.css`:

- `.rtl-text` - Sets direction RTL, text-align right, and `unicode-bidi: plaintext` for Arabic content
- `.ltr-text` - Sets direction LTR, text-align left, and `unicode-bidi: plaintext` for English/URLs/code
- `.bidi-plain` - Applies `unicode-bidi: plaintext` for mixed content
- `.bidi-isolate` - Applies `unicode-bidi: isolate` for isolated bidirectional text

### RTL Application Guidelines

**When to use `.rtl-text`:**
- All Arabic summaries (short, medium, full, very long)
- Video titles (may contain Arabic)
- Channel names (may contain Arabic)
- Category labels (Arabic)
- Priority labels (if localized to Arabic)
- Empty state messages (Arabic)
- Description text (Arabic)
- Key ideas and action items (Arabic)

**When to use `.ltr-text`:**
- Date/time strings (English format)
- URLs and YouTube video IDs
- Code snippets or technical identifiers
- English-only metadata values

**Mixed Content Handling:**
- Use `unicode-bidi: plaintext` (via `.rtl-text` or `.bidi-plain`) for user-generated content that may contain mixed Arabic and English
- The browser will automatically handle inline English phrases within Arabic paragraphs
- For explicit LTR spans within RTL text, wrap with `<span dir="ltr" className="ltr-text">...</span>`

### Components with RTL Support

- **VideoCard**: Titles, summaries, channel names, categories
- **VideoDetailsPage**: All summaries, key ideas, action items, titles, channel names
- **EmptyState**: Descriptions
- **Toggle**: Descriptions
- **Settings**: All text content

### BiDi Class Usage Rules

**When to use `.rtl-text`:**
- All Arabic summaries (short, medium, full, very long)
- Video titles (may contain Arabic)
- Channel names (may contain Arabic)
- Category labels (Arabic)
- Priority labels (if localized to Arabic)
- Empty state messages (Arabic)
- Description text (Arabic)
- Key ideas and action items (Arabic)
- Filter chips with Arabic labels (automatically detected by Chip component)

**When to use `.ltr-text`:**
- Date/time strings (English format: "MMM d, yyyy", "h:mm a", etc.)
- URLs and YouTube video IDs
- Code snippets or technical identifiers (Sheet IDs, build hashes)
- Timestamps and relative time strings ("2 hours ago")
- Numeric metadata values in English format

**Automatic Detection:**
- The `Chip` component automatically detects Arabic characters and applies `.rtl-text` when needed
- This ensures category and priority filter chips render correctly without manual intervention

### Developer Notes

- Always apply `.rtl-text` to Arabic content containers
- Use `.ltr-text` for English-only metadata or technical values
- Test with mixed Arabic/English content to ensure proper rendering
- URLs and code-like tokens are automatically handled by the browser when using `unicode-bidi: plaintext`
- The `Chip` component handles RTL automatically for Arabic labels

### Known Edge Cases

1. **Mixed Arabic/English in summaries**: The browser's `unicode-bidi: plaintext` handles inline English phrases automatically. No manual wrapping needed for most cases.

2. **Date/time formatting**: All date/time strings use `.ltr-text` to ensure proper formatting regardless of document direction.

3. **Filter chips**: The `Chip` component automatically detects Arabic and applies RTL, so category and priority filters work correctly.

4. **Technical identifiers**: Sheet IDs, build hashes, and other code-like values always use `.ltr-text` to maintain readability.

5. **Channel names with mixed content**: Channel names use `.rtl-text` as they are primarily Arabic, but embedded English will render correctly due to `unicode-bidi: plaintext`.

## ðŸ”§ Engineering Workflow and Verification

### Change-Set Definition

A **change-set** is a logical unit of work that:
- Solves one specific problem or adds one feature
- Is self-contained and testable
- Can be verified independently
- Has clear success criteria

Examples:
- Adding a new filter option
- Fixing filter state inconsistency
- Updating UI components
- Refactoring store logic

### Mandatory Workflow Per Change-Set

**Every change-set MUST end with these steps in order:**

1. **Local Verification**
   ```bash
   pnpm install          # Ensure dependencies are up to date
   pnpm typecheck        # Verify TypeScript types are correct
   pnpm build            # Ensure build completes successfully
   ```
   - Type check must pass with no errors
   - Build must complete successfully
   - Check for build warnings

2. **Local Dev Verification**
   ```bash
   pnpm dev
   ```
   - Test changed functionality in browser
   - Verify no console errors
   - Check responsive behavior

3. **Commit**
   - Use clear, descriptive commit messages (see Commit Message Conventions below)
   - Commit only related changes together
   - Example: `git commit -m "refactor: unify PWA filter state and query building"`

4. **Push to GitHub**
   - Always push immediately after committing
   - Example: `git push origin main`
   - **Deployment is handled by Vercel automatic builds on push to main.**

5. **Deployed Verification (Vercel)**
   - Wait for Vercel auto-deploy to complete
   - Test on production URL
   - Verify PWA cache updates correctly

### Local Dev Verification Steps

**Before committing, verify:**

1. **Build and Type Check:**
   ```bash
   pnpm typecheck && pnpm build
   ```

2. **Dev Server:**
   ```bash
   pnpm dev
   ```
   - Open browser to `http://localhost:5173`
   - Test all affected pages
   - Check browser console for errors

3. **Filter Functionality:**
   - Test date range chips (Today, 3d, 7d)
   - Test status filter (All, New, Read)
   - Test category filter (All + dynamic categories)
   - Test priority filter (All + dynamic priorities)
   - Verify filters work together correctly

4. **Theme Switching:**
   - Toggle between light/dark/system themes
   - Verify theme persists across page navigation

5. **PWA Cache:**
   - Open DevTools â†’ Application â†’ Service Workers
   - Test "Reset App Cache" in Settings
   - Verify service worker updates correctly

### Deployed Verification Steps (Vercel)

**After push and Vercel deploy:**

1. **Production URL:**
   - Open deployed PWA URL
   - Verify no console errors
   - Check network tab for API calls

2. **PWA Cache Hard Refresh:**
   - Open DevTools â†’ Application â†’ Clear storage
   - Click "Clear site data"
   - Reload page
   - Verify app loads correctly

3. **Service Worker Reset:**
   - DevTools â†’ Application â†’ Service Workers
   - Click "Unregister" if needed
   - Reload page to re-register
   - Verify new version is active

4. **Filter UI Verification:**
   - Test all filter chips render correctly
   - Verify "All" chips work (null semantics)
   - Check dynamic categories/priorities load from backend
   - Test filter combinations

### Recheck After Time (6-24 Hours)

After deploying changes, recheck within 6-24 hours:

1. **Production Stability:**
   - Verify no error reports in Vercel logs
   - Check browser console for runtime errors
   - Confirm API calls are successful

2. **PWA Updates:**
   - Test on mobile device if possible
   - Verify service worker updates automatically
   - Check offline functionality still works

3. **Backend Integration:**
   - Verify `getBackendInfo` returns expected data
   - Confirm `allowedCategories` and `allowedPriorities` are consumed correctly
   - Test filter queries match backend expectations

### Operator Checklist (Before Declaring Fix Done)

Use this checklist before marking any change-set as complete:

**Build and Type Check:**
- âœ… `pnpm typecheck` passes
- âœ… `pnpm build` completes without errors

**Local UI Sanity:**
- âœ… Date range chips work (Today, 3d, 7d)
- âœ… Status filter works (All, New, Read)
- âœ… Category filter works (All + dynamic categories from backend)
- âœ… Priority filter works (All + dynamic priorities from backend)
- âœ… Theme switching works (light/dark/system)
- âœ… Filters work together (no conflicts)

**Backend API Sanity:**
```bash
# Test getBackendInfo
curl "YOUR_BACKEND_URL?action=getBackendInfo&token=YOUR_TOKEN"

# Test listVideos
curl "YOUR_BACKEND_URL?action=listVideos&range=3d&token=YOUR_TOKEN"
```

**Expected Results:**
- âœ… `getBackendInfo` returns valid JSON with `allowedCategories` and `allowedPriorities`
- âœ… `listVideos` returns array of videos with correct structure
- âœ… No CORS errors or 500 responses

**PWA Cache and Service Worker:**
- âœ… Service worker registers correctly
- âœ… "Reset App Cache" button works
- âœ… Hard refresh clears stale data
- âœ… New deployments update service worker

**Production Verification:**
- âœ… Vercel deploy succeeds
- âœ… Production URL loads without errors
- âœ… All filter chips render correctly
- âœ… API calls succeed in production

### Commit Message Conventions

Use these prefixes for commit messages:

- **`feat:`** - New feature or capability
  - Example: `feat: render category filters from backend allowedCategories`

- **`fix:`** - Bug fix
  - Example: `fix: handle null keys in filter chip components`

- **`refactor:`** - Code restructuring without changing behavior
  - Example: `refactor: unify PWA filter state and query building`

- **`docs:`** - Documentation changes only
  - Example: `docs: add filter and release verification policy`

- **`chore:`** - Maintenance tasks, dependencies, config
  - Example: `chore: update dependencies`

- **`style:`** - Code style changes (formatting, whitespace)
  - Example: `style: format code with prettier`

**Format:** `<type>: <brief description>`

Keep descriptions concise but descriptive. If needed, add a body paragraph explaining the "why" for complex changes.

## ðŸ“– Documentation

- **[ARCHITECTURE.md](docs/ARCHITECTURE.md)** - System architecture and data flow
- **[CODING_GUIDELINES.md](docs/CODING_GUIDELINES.md)** - Code standards and patterns
- **[FEATURES.md](docs/FEATURES.md)** - Feature documentation per page
- **[Quickstart](docs/QUICKSTART.md)** - Quick setup guide
- **[Reference](docs/reference/CODE_REFERENCE.md)** - Codebase reference
- **[Reports](docs/reports/)** - Project status and progress reports

---

## ðŸ” Freshness Gap Troubleshooting

If the PWA shows older videos than what's in the Google Sheet, follow this systematic troubleshooting checklist.

### Root Causes to Check

1. **Sheet ID Mismatch**
   - The backend may be reading from a different sheet than expected
   - Verify: Call `getBackendInfo` and check `sheetId` matches your production sheet

2. **API Response Caching**
   - Browser or Service Worker may be caching old API responses
   - Verify: Check Network tab in DevTools for `listVideos` calls

3. **Date/Time Parsing Issues**
   - Videos may be filtered out due to timezone or parsing errors
   - Verify: Check backend logs for "handleListVideos_: Newest video" line

4. **Column Resolution Issues**
   - Headers may have changed, causing wrong column reads
   - Verify: Check `VIDEOS_HEADERS` and `VIDEOS_COL_INDEXES` in `checkBackfillStatus` logs

5. **Store State Not Clearing**
   - Frontend may be appending to old state instead of replacing
   - Verify: Check `videosStore.ts` - `fetchVideos` already clears state before fetching

### 5-Step Operator Checklist

**Step 1: Verify Sheet Ground Truth**
- Open Google Sheet directly
- In Videos sheet, find newest row within last 3 days
- Record: Date, Time, VideoId, Status

**Step 2: Verify Backend Sheet Binding**
```bash
# Call getBackendInfo
curl "YOUR_BACKEND_URL?action=getBackendInfo&apiToken=YOUR_TOKEN"

# Verify:
# - sheetId matches your production sheet
# - apiVersion is current
# - lastSuccessfulRunAt is recent
```

**Step 3: Test API Directly**
```bash
# Call listVideos with cache-buster
curl "YOUR_BACKEND_URL?action=listVideos&range=3d&apiToken=YOUR_TOKEN&_cb=$(date +%s)"

# Verify:
# - Newest video from Step 1 appears in response
# - publishedAt timestamp matches Sheet Date+Time
# - Response is JSON (not cached HTML)
```

**Step 4: Check PWA Network Tab**
- Open deployed PWA with DevTools
- Go to Network tab
- Filter by "listVideos"
- Verify:
  - Request URL includes `_cb=` cache-buster
  - Response includes newest video from Step 1
  - Response headers don't show caching (if visible)

**Step 5: Reset PWA Cache**
- Go to Settings page
- Click "Reset App Cache"
- Reload page
- Verify newest video now appears

### Debug Tools

**Backend:**
- `checkBackfillStatus(3)` - Shows window status and column indices
- `inspectVideoStatuses(3)` - Shows status histogram
- Backend logs show "handleListVideos_: Newest video" with ID and timestamp

**Frontend:**
- DevTools Network tab - Shows actual API requests/responses
- DevTools Application tab - Shows Service Worker and cache status
- Console logs - Check for API errors

### Prevention Measures

- âœ… Frontend uses `cache: 'no-store'` in fetch options
- âœ… Frontend adds `_cb=` cache-buster to `listVideos` requests
- âœ… Service Worker uses `NetworkOnly` with no cacheable responses for API endpoints
- âœ… Store clears videos before fetching new data
- âœ… Backend logs newest video for verification

## ðŸ”§ Troubleshooting

### Build Errors
- Ensure `tsconfig.json` has proper path aliases
- Restart IDE after configuration changes

### PWA Not Installing
- PWA requires HTTPS in production
- Check manifest.json in DevTools â†’ Application

### API Connection Issues
- **Verify Backend URL:** Check `VITE_BACKEND_URL` in your Vercel/environment settings.
- **Anonymous Access:** The Apps Script Web App **MUST** be set to execute as "Me" and access "Anyone" (Anonymous). If set to "Anyone with Google Account", the PWA will fail with CORS/Network errors because it cannot handle the login redirect flow.
- **Test with Curl:** `curl -L "YOUR_BACKEND_URL?action=getBackendInfo"`. It should return JSON, not HTML.

### Data Not Updating
- **App Updates:** The PWA caches heavily. If meaningful changes (like backend URL) are made, you may need to:
    1.  Open DevTools -> Application -> Service Workers -> **Unregister**.
    2.  Reload the page (Cmd+Shift+R).
- **Default Filters:** The app defaults to recent data (3d). Check if your backend has processed new videos recently using the Activity Log.

### Styling / Dark Mode
- **Tailwind v4 Note:** We use a custom variant `@custom-variant dark (&:where(.dark, .dark *));` in `src/styles/globals.css` because standard Tailwind v4 dark mode relies purely on system reference. This custom rule allows our specific `.dark` class toggle to work correctly to support manual theme switching.

---

## ðŸ“„ License

MIT

---

**Version:** 1.0.0  
**Last Updated:** 2025-12-04

---

## References

### Project Reference
- [Project Idea & Discussion](https://chatgpt.com/c/692fe539-bba8-832f-9a51-2405f17885cc)

### Design Reference
- [Stitch Project](https://stitch.withgoogle.com/projects/7484079189251965390)

### YouTube Digest Backend (Apps Script)
- [Google Apps Script Project](https://script.google.com/u/0/home/projects/1YoPbY_AK0pFIJ6eFv8FxtRyyA3p1hlBHW19n19VT-eKFLpBnZgllB_T_)

### YouTube Summarizer Backend (GitHub Repo)
- [yt-subscriptions-summarizer](https://github.com/AlaaEddinAlbarghoth/yt-subscriptions-summarizer)
